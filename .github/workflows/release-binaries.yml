name: Release Binaries

on:
  release:
    types: [published, prereleased]

permissions:
  contents: write

jobs:
  build-and-upload:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Inject release version
        shell: bash
        run: |
          tag="${GITHUB_REF_NAME}"
          printf '%s\n' '"""Build-time version override injected by release workflow."""' > src/qrcodr/_build_version.py
          printf '%s\n' >> src/qrcodr/_build_version.py
          printf 'BUILD_VERSION: str | None = "%s"\n' "${tag}" >> src/qrcodr/_build_version.py

      - name: Create venv
        id: venv
        shell: bash
        run: |
          python -m venv .venv
          if [ "${RUNNER_OS}" = "Windows" ]; then
            echo "python_path=.venv/Scripts/python.exe" >> "$GITHUB_OUTPUT"
          else
            echo "python_path=.venv/bin/python" >> "$GITHUB_OUTPUT"
          fi

      - name: Install dependencies
        shell: bash
        run: |
          "${{ steps.venv.outputs.python_path }}" -m pip install --upgrade pip
          "${{ steps.venv.outputs.python_path }}" -m pip install -e .[dev]

      - name: Build one-file binary
        shell: bash
        run: |
          "${{ steps.venv.outputs.python_path }}" -m PyInstaller \
            --noconfirm \
            --clean \
            --onefile \
            --windowed \
            --name qrcodr \
            run_qrcodr.py

      - name: Package artifact
        id: package
        shell: bash
        run: |
          archive="$("${{ steps.venv.outputs.python_path }}" - <<'PY'
import os
from pathlib import Path
import zipfile

runner_os = os.environ["RUNNER_OS"].lower()
version = os.environ["GITHUB_REF_NAME"]
executable = Path("dist/qrcodr.exe") if os.environ["RUNNER_OS"] == "Windows" else Path("dist/qrcodr")
archive = Path(f"qrcodr-{version}-{runner_os}.zip")

with zipfile.ZipFile(archive, "w", compression=zipfile.ZIP_DEFLATED) as zf:
    zf.write(executable, executable.name)

print(archive)
PY
)"
          echo "archive=${archive}" >> "$GITHUB_OUTPUT"

      - name: Upload to release
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ steps.package.outputs.archive }}
