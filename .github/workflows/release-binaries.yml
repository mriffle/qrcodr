name: Release Binaries

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: "Release tag to attach binaries to (for example v1.2.9)"
        required: true
        type: string
  release:
    types: [published]

permissions:
  contents: write

jobs:
  build-and-upload:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    env:
      RELEASE_TAG: ${{ github.event.release.tag_name || inputs.release_tag }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Inject release version
        shell: bash
        run: |
          tag="${RELEASE_TAG}"
          printf '%s\n' '"""Build-time version override injected by release workflow."""' > src/qrcodr/_build_version.py
          printf '%s\n' >> src/qrcodr/_build_version.py
          printf 'BUILD_VERSION: str | None = "%s"\n' "${tag}" >> src/qrcodr/_build_version.py

      - name: Create venv
        id: venv
        shell: bash
        run: |
          python -m venv .venv
          if [ "${RUNNER_OS}" = "Windows" ]; then
            echo "python_path=.venv/Scripts/python.exe" >> "$GITHUB_OUTPUT"
          else
            echo "python_path=.venv/bin/python" >> "$GITHUB_OUTPUT"
          fi

      - name: Install dependencies
        shell: bash
        run: |
          "${{ steps.venv.outputs.python_path }}" -m pip install --upgrade pip
          "${{ steps.venv.outputs.python_path }}" -m pip install -e .[dev]

      - name: Build one-file binary
        shell: bash
        run: |
          "${{ steps.venv.outputs.python_path }}" -m PyInstaller \
            --noconfirm \
            --clean \
            --onefile \
            --windowed \
            --name qrcodr \
            run_qrcodr.py

      - name: Prepare binary and checksum
        id: package
        shell: bash
        run: |
          runner_os="$(echo "${RUNNER_OS}" | tr '[:upper:]' '[:lower:]')"
          if [ "${RUNNER_OS}" = "Windows" ]; then
            binary_name="qrcodr-${RELEASE_TAG}-${runner_os}.exe"
          else
            binary_name="qrcodr-${RELEASE_TAG}-${runner_os}"
          fi
          "${{ steps.venv.outputs.python_path }}" -c "import hashlib, os, shutil; from pathlib import Path; runner = os.environ['RUNNER_OS'].lower(); version = os.environ['RELEASE_TAG']; source = Path('dist/qrcodr.exe') if os.environ['RUNNER_OS'] == 'Windows' else Path('dist/qrcodr'); ext = '.exe' if os.environ['RUNNER_OS'] == 'Windows' else ''; binary = Path(f'qrcodr-{version}-{runner}{ext}'); shutil.copy2(source, binary); digest = hashlib.sha256(binary.read_bytes()).hexdigest(); checksum = Path(f'{binary.name}.sha256'); checksum.write_text(f'{digest}  {binary.name}\n', encoding='utf-8'); print(binary); print(checksum)"
          echo "binary=${binary_name}" >> "$GITHUB_OUTPUT"
          echo "checksum=${binary_name}.sha256" >> "$GITHUB_OUTPUT"

      - name: Upload to release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          files: |
            ${{ steps.package.outputs.binary }}
            ${{ steps.package.outputs.checksum }}
          overwrite_files: true
